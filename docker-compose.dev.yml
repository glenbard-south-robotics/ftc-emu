version: "3.8"

services:
  wasm-builder:
    build:
      context: .
      dockerfile: library/Dockerfile.dev
    volumes:
      - .:/workspace:cached
      - wasm-pkg:/workspace/ftc-emu-www/pkg

      - cargo-registry:/usr/local/cargo/registry
      - cargo-git:/usr/local/cargo/git
      - wasm-target:/workspace/target
    environment:
      - CARGO_HOME=/usr/local/cargo
    command: /usr/local/bin/watch-wasm.sh

  vite-dev:
    build:
      context: ./ftc-emu-www
      dockerfile: Dockerfile.dev
    ports:
      - "5173:5173"
    volumes:
      - ./ftc-emu-www/src:/app/src:cached
      - ./ftc-emu-www/index.html:/app/index.html:ro
      - ./ftc-emu-www/vite.config.ts:/app/vite.config.ts:ro
      - ./ftc-emu-www/tsconfig.json:/app/tsconfig.json:ro
      - ./ftc-emu-www/tsconfig.app.json:/app/tsconfig.app.json:ro

      - wasm-pkg:/app/pkg:ro
      - node-modules:/app/node_modules
    environment:
      - VITE_HOST=0.0.0.0
      - CHOKIDAR_USEPOLLING=true
    depends_on:
      - wasm-builder
    command: pnpm run dev

volumes:
  wasm-pkg:
  cargo-registry:
  cargo-git:
  wasm-target:
  node-modules:
