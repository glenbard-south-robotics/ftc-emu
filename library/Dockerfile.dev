FROM rust:1.91-bookworm

# Install wasm-pack and cargo-watch
RUN curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh && \
    cargo install cargo-watch

WORKDIR /workspace

# Create watch script in /usr/local/bin (won't be overwritten by volume mount)
RUN printf '#!/bin/bash\n\
set -e\n\
\n\
echo "Starting WASM builder with hot reload..."\n\
echo "Watching library/ftc-emu-core for changes..."\n\
\n\
# Initial build\n\
cd /workspace/library/ftc-emu-core\n\
wasm-pack build --target web --out-dir ../../ftc-emu-www/pkg\n\
\n\
# Watch for changes\n\
cargo watch -s "wasm-pack build --target web --out-dir ../../ftc-emu-www/pkg" -w src -w Cargo.toml\n' \
> /usr/local/bin/watch-wasm.sh && chmod +x /usr/local/bin/watch-wasm.sh

CMD ["/usr/local/bin/watch-wasm.sh"]
